\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{logger}[2024/07/19 v1.5 Table Logger with Structured Output]

\RequirePackage{etoolbox}
\RequirePackage{zref-user}
\RequirePackage{zref-savepos}

\AtBeginDocument{%
  % Open log file
  \newwrite\outputfile
  \immediate\openout\outputfile=output.json
  \immediate\write\outputfile{[}

  % Counter for tables
  \newcounter{loggertable}

  % Patch the table environment
  \patchcmd{\table}
    {\@float{table}}
    {\@float{table}%
     \stepcounter{loggertable}%
     \zsavepos{table-start-\theloggertable}}
    {}{}

  \patchcmd{\endtable}
    {\end@float}
    {\zsavepos{table-end-\theloggertable}%
     \immediate\write\outputfile{%
       \space\space\{%
         "table": \theloggertable,%
         "page": \thepage,%
         "start": \{\space"x": \zposx{table-start-\theloggertable}, "y": \zposy{table-start-\theloggertable}\space\},%
         "end": \{\space"x": \zposx{table-end-\theloggertable}, "y": \zposy{table-end-\theloggertable}\space\}%
       \},% 
     }%
     \end@float}
    {}{}
}

\AtEndDocument{%
  \immediate\write\outputfile{]}%
  \immediate\closeout\outputfile
}

\endinput